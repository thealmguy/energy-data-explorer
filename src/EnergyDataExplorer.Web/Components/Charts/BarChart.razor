@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<canvas id="@ElementId"></canvas>

@code {
    [Parameter, EditorRequired] public string ElementId { get; set; } = default!;
    [Parameter, EditorRequired] public IReadOnlyList<string> Labels { get; set; } = default!;
    [Parameter, EditorRequired] public IReadOnlyList<ChartDataset> Datasets { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RenderChart();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        await JS.InvokeVoidAsync("chartInterop.updateChart", ElementId, Labels, Datasets);
    }

    private async Task RenderChart()
    {
        var config = new
        {
            type = "bar",
            data = new { labels = Labels, datasets = Datasets },
            options = new
            {
                responsive = true,
                plugins = new { legend = new { position = "top" } },
                scales = new
                {
                    y = new { title = new { display = true, text = "kWh" }, beginAtZero = true }
                }
            }
        };
        await JS.InvokeVoidAsync("chartInterop.createChart", ElementId, config);
    }

    public async ValueTask DisposeAsync()
    {
        await JS.InvokeVoidAsync("chartInterop.destroyChart", ElementId);
    }

    public sealed record ChartDataset(
        string Label,
        IReadOnlyList<object?> Data,
        string BackgroundColor = "rgba(54,162,235,0.7)",
        string BorderColor = "#36a2eb");
}
